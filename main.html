<!DOCTYPE html>
<html>
<!--

CrestJson 0.01 (pronounce like Crest-John)
Beta Build

This is an open source html5 configurable script that will allow Andriod
devices, Windows ie Chrome/Firefox, Windows Phones, Mac (yuck),
and other compatible html5 devices access your crestron control system.
This appliction uses a CrestJson server a a proxy
to communication with the actual devices via Json objects.

Installation:  This is a single page application that can be installed on
your creston device if it has a web server.  Assuming
its connected to the internet this is the only file that is needed.

1.  Room names must be distinct and have not spaces, this goes for names in
general not just specific to rooms
2.


Nick Tullos
Tullostech@gmail.com
-->

  <head>
  <title>CrestJson 0.0a 2013/04/10</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    

<script>
	//server configuration
	var URL = "http://192.168.0.12:8080/api/CrestJson";
	//var URL = "http://localhost:8080/api/CrestJson";
  
  //client config
  var Collapse = true; // collapse all panels 1 minutes after the last call and other automatic collapsing features.

	$(function () {
	    //build the room list will come from the server when out of demo mode.. demo mode still works against a live server
	    //mock up Json objects and setup form based on data
	    /*
        *
        *  Configure rooms below
        *
        */
	    var Data = {}
	    Data.systempower = { name: "Power", id: "15", type: "D", value: "true", slot: "0" };
	    Data.systemsources = { name: "All", systemsrc: [{ name: "Mute" }, { name: "XBMC" }, { name: "Android" }, { name: "Zune" }, { name: "Shuffler" }] };
	    Data.Rooms = [];
	    var Room = {}
	    Room.name = "Kitchen";
	    Room.srclist =
		[{ name: "Power", id: "9", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "Mute", id: "3", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "XBMC", id: "17", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Android", id: "18", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Zune", id: "19", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Shuffler", id: "20", type: "D", value: "true", slot: "0", source: "true" }]
	    Room.volume =
		{ name: "Volume", id: "1", type: "A", max: "45000", min: "0" }

	    Data.Rooms.push(Room);
	    var Room2 = {}
	    Room2.name = "Library";
	    Room2.srclist = 
		[{ name: "Power", id: "14", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "Mute", id: "8", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "XBMC", id: "42", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Android", id: "43", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Zune", id: "44", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Shuffler", id: "45", type: "D", value: "true", slot: "0", source: "true" }]
	    Room2.volume =
		{ name: "Volume", id: "6", type: "A", max: "45000", min: "0", slot: "0" }
	    Data.Rooms.push(Room2);
	    var Room3 = {}
	    Room3.name = "Frontyard";
	    Room3.srclist = 
		[{ name: "Power", id: "11", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "Mute", id: "5", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "XBMC", id: "27", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Android", id: "28", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Zune", id: "29", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Shuffler", id: "30", type: "D", value: "true", slot: "0", source: "true" }];
	    Room3.volume =
		{ name: "Volume", id: "3", type: "A", max: "45000", min: "0" }
	    Data.Rooms.push(Room3);
	    var Room4 = {}
	    Room4.name = "Backyard";
	    Room4.srclist = 
		[{ name: "Power", id: "10", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "Mute", id: "1", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "XBMC", id: "22", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Android", id: "23", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Zune", id: "24", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Shuffler", id: "25", type: "D", value: "true", slot: "0", source: "true" }];
	    Room4.volume =
		{ name: "Volume", id: "2", type: "A", max: "45000", min: "0" }
	    Data.Rooms.push(Room4);
	    var Room5 = {}
	    Room5.name = "Garage";
	    Room5.srclist = 
		[{ name: "Power", id: "12", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "Mute", id: "6", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "XBMC", id: "32", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Android", id: "33", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Zune", id: "34", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Shuffler", id: "35", type: "D", value: "true", slot: "0", source: "true" }];
	    Room5.volume =
		{ name: "Volume", id: "4", type: "A", max: "45000", min: "0" }
	    Data.Rooms.push(Room5);
	    var Room6 = {}
	    Room6.name = "Bathroom";
	    Room6.srclist = 
		[{ name: "Power", id: "13", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "Mute", id: "7", type: "D", value: "true", slot: "0", source: "false" },
		{ name: "XBMC", id: "37", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Android", id: "38", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Zune", id: "39", type: "D", value: "true", slot: "0", source: "true" },
		{ name: "Shuffler", id: "40", type: "D", value: "true", slot: "0", source: "true" }];
	    Room6.volume =
		{ name: "Volume", id: "5", type: "A", max: "45000", min: "0" }
	    Data.Rooms.push(Room6);
	    /*
        * End of configuration example
        */

	    //create the UI from the Mock data
	    CreateUI(Data);

	});


	//default connection status
	self.connection = false;
	self.tryingtocollaspe = false; //is the timer running that will collapse all panels
  
	//support cross domain connections
	$.support.cors = true;

	function BindVolumeControls(Room) {
		$('#Volume'+Room.name).on('slidestop', function (event)
		{
			defaultval = 0;
			self = this;
			var slider_value = $('#Volume' + Room.name).slider().val();
			Send(Room.volume.id, Room.volume.type, 0, slider_value);
		});
	}

	function BindControls(data) {
		//bind each room's volume control
		$.each(data.Rooms, function (intIndex, room) {
			BindVolumeControls(room)
		});

	}

	//Generate UI for rooms
	function GenerateUIforRooms(data)
	{
		self = this;
		self.CrestJsonData = data;
		// Genarate power for the add power
		$('#content').append(GenerateUISystemPowerButton(data.systempower.name));
		//generate UI for party buttons
		GenerateUIforPartyButton(data.systemsources);
		//add each room
		$.each(data.Rooms, function (intIndex, Room) {
			AddNewRoom(Room);
		});

	}

	function GenerateUIforPartyButton(systemsources)
	{
		//1. add collaspable
		//2. add sources
		if (systemsources != null)
		{
			var collapsable = GenerateUICollapsable(systemsources.name)
			$('#content').append(collapsable);
			$.each(systemsources.systemsrc, function (intIndex, src)
			{
				//src.name
				var button = GenerateUISystemPartyButton(src);
				$('#' + systemsources.name).append(button);
			}
			)
		}

	}

	function SendPartySrc(sourcename)
	{
	    self = this;
	    BroadcastSrcCommand(self.CrestJsonData.Rooms, sourcename);
	}

	function GenerateUISystemPartyButton(button)
	{

		return '<a href="#" data-role="button" onclick="SendPartySrc(\'' + button.name + '\') "> ' + button.name + ' </a>';
	}
		
	function GenerateUISystemPowerButton(buttonname)
	{
		return '<a href="#" data-role="button"  onclick="SendDigitalSystemPower() "> ' + buttonname + ' </a>';
	}

	function GenerateUICollapsable(name)
	{
		return '<div data-role="collapsible" data-theme="b"  data-collapsed="true" id = "' + name + '"><h3> ' + name + ' </h3><span></span></div>';
	}

	function GenerateUIDigalButton(roomname,id,buttonname)
	{
		return  '<a href="#" data-role="button"  onclick="SendDigital(\'' + roomname + '\',' + id + ') "> ' + buttonname + ' </a>';
	}
	function GenerateUISlider(HTMLID, button) {
		return '<label for="slider1">' + button.name + '<input type="range"  id=' + HTMLID + ' min="0" max=\'' + button.max + '\' value="0" data-popup-enabled="false"   data-theme="d" >';
	}

	function AddNewRoom(Room) {
		//1. Add ID to room list.
		//2. InsertID into HTML Room
		//3. Add Power Button
		//4. Get SignalList and create source buttons
		//5. Add Volume control
		//6. Add Mute Button
		//7. Refresh All New Content

		var rm = GenerateUICollapsable(Room.name);
		$('#content').append(rm);

		$.each(Room.srclist,
		function (intIndex, src) {
			var btnsrc = GenerateUIDigalButton(Room.name, src.id, src.name);
			$('#' + Room.name).append(btnsrc);
		});

		//wire up the volume control
		volHTMLID = Room.volume.name + Room.name;
		var volsrc = GenerateUISlider(volHTMLID,Room.volume);
		//add the volume control too the dynamic room panel
		$('#' + Room.name).append(volsrc);


	}

	function SendDigitalSystemPower()
	{
		var Button = this.CrestJsonData.systempower;
		UpdateDigitaleValue(Button);
	}

	//get previous value and send the opposite
	//bug this will not turn the system On..
	function UpdateDigitaleValue(Button)
	{

		if (Button.value == "true")
		{
			PulseOff(Button);
		}
		else {
			Button.value = "true";
		}

		Send(Button.id, Button.type, Button.slot, Button.value);
		Send(Button.id, Button.type, Button.slot, Button.value);
	}

	function PulseOff(Button)
	{
		function Pulser(Button)
		{Send(Button.id,Button.type,"0","true");
			Send(Button.id,Button.type,"0","false");}

		setTimeout(function(){Pulser(Button)},200);
		setTimeout(function(){Pulser(Button)},200);
		setTimeout(function(){Pulser(Button)},0);
	}

	function PulseOn(Button)
	{
		function Pulser(Button)
		{Send(Button.id,Button.type,"0","false");
			Send(Button.id,Button.type,"0","true");}

		setTimeout(function(){Pulser(Button)},200);
		setTimeout(function(){Pulser(Button)},200);
		setTimeout(function(){Pulser(Button)},0);
	}
	//
	// this function will is for party mode, it will turn on the same source for all rooms
	//
	function BroadcastSrcCommand(RoomList, src)
	{
		var source;
		$.each(RoomList, function (index, Room) {
		    source = null;
		    $.each(Room.srclist, function (index, Button) {		        
				if (Button.name == src) {
					source = Button;
				}
				else {
					//only turn off ALL the sources in the buttonlist
					if (Button.source == "true") {
						Send(Button.id, Button.type, "0", "false");
					}
				}

			});//end of room foreach loop

		    //its possible for a room not to have the source requested
			if (source != null)
			    PulseOn(source);
		});//end of roomlist foreach loop
	
	}

//
// this function will close all the panels after two minutes of the last send commmand
//
function collapseAll(){

$("div[data-role='collapsible']").each(function() {
        var coll = $(this);
        coll.trigger('collapse');
    });
}


	//
	// this function will turn all all source include the one requested to be turned on, then pulse low/high to the requested button
	//
	function BroadcastRoomCommand(Room,ID)
	{
		//turn everything off
		var source;
		$.each(Room, function (index, Button)
		{
			//only turn off the sources in the buttonlist
			if (Button.source == "true")
			{
				Send(Button.id,Button.type,"0","false");
			}
			//find the button that needs to send the command
			if (Button.id == ID)
			{
				source =Button;
			}
		})
		//pulse the source you want to turn on
		    PulseOn(source);

	}
	//When digital since we are not receiving feedback in this version we must  locally store the last value sent and swap so we can send true and false
	function SendDigital(RoomName,ID)
	{
		self = this;
		//loop through the rooms to find the room
		//add each room
		$.each(self.CrestJsonData.Rooms, function (intIndex, Room) {
			var CurrentRoom = Room;
			if (RoomName == Room.name)
			{
				BroadcastRoomCommand(CurrentRoom.srclist,ID);
			}
		});

	}
	
	//checks the status of the server
	function SendPing()
	{
	Send("D", "-1","0", "true");
	}
	
	function DisplayStatus(msg)
	{
	$("#statusmsg").text(msg);
	}

	//build data.. here is an example for analog,digital,serial
	//{"Type":"A","ID":"6","Slot":"0","Value":"30000"}
	//{"Type":"D","ID":"6","Slot":"0","Value":"false"}
	//{"Type":"S","ID":"6","Slot":"0","Value":"nottested????"}
	function Send(ID, Type, Slot, value) {
		var data = {};
		data.Type = Type;
		data.ID = ID
		data.Slot = Slot;
		data.Value = value;
		//send call
		$.ajax({
			self:this,
			type: 'POST',
			url: URL,
			dataType: 'json',
			data: data,
			crossDomain: true,
			success: function () {
				//alert("Status: success");
				self.connection = true;
				DisplayStatus("Status:  Connected");				
			},
			error: function (XMLHttpRequest, textStatus, errorThrown) {
			DisplayStatus("Status: Connection Error");				
				if (self.connection != false)
				{
				alert("Connection Error:  Is the Web API controller running at IP ?" + URL);
				self.connection = false;
				}
			},
      complete: function()
      {
      if (this.Collapse == true)
      {
      /*
      1. create unique ID
      2. set a the globle ID 
      3. when timeout expires see if that ID is yours, if not then your not the last call .. ignore the collapse
          */
         //this has problems that can be fix with the above psudo code 
         setTimeout(function()
          {
          collapseAll()
          }
          ,1000*60*5);

      }
      }

		});

	}

//
// this function will automatically collapse all other panels and scroll the active panel to the top
//
function BindAutoCollaspeAndScroll()
{
if (this.Collapse == true)
{
    var $collapse = $("div[data-role='collapsible']")
    
    $collapse.bind('expand', function () 
    {
     $collapse.not(this).trigger('collapse');
     $('html, body').animate({
     scrollTop: $(this).offset().top
     });
    });
}
}



$(document).delegate('#my-page-id', 'pageinit', function () {
/*
  */  
    });

function CreateUI(data)
	{
  
    
   
		//Lets go ahead and try to connect to the server
		SendPing();
		//Generate the UI Controls	    
		GenerateUIforRooms(data);
		//update UI
		$('#content').trigger("create");
		//bind the volume sliders
		BindControls(data);
    collapseAll();
    BindAutoCollaspeAndScroll();
    
    Aut
    
	}


	

  </script>
<style type="text/css">
input.ui-slider-input {
display : none !important;
}
</style>
 </head>

  <body>
<!-- Home -->
<div data-role="page" id="page1">
	<div id="Header" data-theme="a" data-role="header">
				<h4>
				Welcome:
				</h4>
	</div>
	
	<div data-role="content" id ="content">
	
  </div>
	
	<div id="footer" data-theme="a" data-role="footer" data-position="fixed">
				<h3>
				<div id = "statusmsg">
					Status:
					</div>
				</h3>
    </div>
 </div>
  </body>
</html>
